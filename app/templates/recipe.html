{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div style="padding: 50px 0; display: flex; justify-content: center;">
    <div style="width: 900px;">

        <h2 class="tm-section-title tm-mb-45 text-center" style="text-align: center; margin-bottom: 40px;">Создание рецепта</h2>

        <form id="recipe-form" novalidate style="width: 100%;">

            <div style="display: flex; flex-direction: column; gap: 40px; margin-bottom: 50px;">
                <div style="display: flex; flex-direction: column;">
                    <label for="title" style="font-weight: 700; margin-bottom: 10px;">Название рецепта:</label>
                    <input type="text" id="title" name="title" required
                        style="width: 100%; font-size: 20px; padding: 14px; border: 1px solid #ccc; border-radius: 6px; min-height: 50px;">
                </div>

                <div style="display: flex; flex-direction: column;">
                    <label for="body" style="font-weight: 700; margin-bottom: 10px;">Описание:</label>
                    <textarea id="body" name="body" required
                        style="width: 100%; font-size: 20px; padding: 14px; border: 1px solid #ccc; border-radius: 6px; min-height: 200px; resize: vertical;"></textarea>
                </div>
            </div>

            <div id="products-container" style="display: flex; flex-direction: column; gap: 25px; margin-bottom: 30px;">
                <div class="product-block" style="display: flex; align-items: center; gap: 10px; width: 100%;">
                    
                    <!-- Метка для выбора продукта -->
                    <div style="flex: 3; display: flex; flex-direction: column;">
                        <label for="product_id" style="font-weight: 700; margin-bottom: 8px;">Продукты:</label>
                        <select name="product_id" required
                                style="font-size: 20px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; min-height: 50px;">
                            <option value="">-- Выберите продукт --</option>
                        </select>
                    </div>
            
                    <!-- Метка и поле для грамм -->
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <label style="font-weight: 700; margin-bottom: 8px;">Граммы:</label>
                        <input type="number" name="quantity" min="0" required
                               style="font-size: 20px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; min-height: 50px;">
                    </div>
            
                    <!-- Кнопка удаления -->
                    <button type="button" onclick="removeProduct(this)"
                        style="height: 30px; width: 30px; font-size: 30px; color: white; background-color: red; border: none; 
                        display: flex; justify-content: center; align-items: center; margin-top: 30px; cursor: pointer;">×</button>
                </div>
            </div>

            <button type="button" onclick="addProduct()"
                style="background-color: rgba(20, 113, 219, 0.514); color: white; border: none; width: 30px; height: 30px;
                font-size: 30px; cursor: pointer; margin-bottom: 20px; display: flex; justify-content: center; align-items: center;">+</button>

            <button type="submit"
                style="background-color: green; color: white; border: none; padding: 16px 0; font-size: 22px; cursor: pointer; width: 100%;">Создать рецепт</button>
        </form>

        <pre id="response" hidden
            style="margin-top: 25px; white-space: pre-wrap; background: #f9f9f9; padding: 20px; border-radius: 6px; border: 1px solid #ddd;"></pre>
    </div>
</div>

<script>
    let productsList = [];

    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('http://127.0.0.1:8000/api/v1/products/');
            productsList = await res.json();

            productsList.sort((a, b) => a.name.localeCompare(b.name, 'ru', { sensitivity: 'base' }));

            populateAllProductSelects();
        } catch (err) {
            alert("Ошибка при загрузке списка продуктов");
            console.error(err);
        }
    });

    function populateProductSelect(selectElement) {
        selectElement.innerHTML = '<option value="">-- Выберите продукт --</option>';
        productsList.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.name;
            selectElement.appendChild(option);
        });
    }

    function populateAllProductSelects() {
        const selects = document.querySelectorAll('select[name="product_id"]');
        selects.forEach(select => populateProductSelect(select));
    }

    function addProduct() {
        const container = document.getElementById('products-container');
        const productBlock = document.createElement('div');
        productBlock.className = 'product-block';
        productBlock.style.cssText = 'display: flex; align-items: center; gap: 10px; width: 100%;';

        productBlock.innerHTML = ` 
            <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                <!-- Метка для выбора продукта -->
                <div style="flex: 3; display: flex; flex-direction: column;">
                    <label for="product_id" style="font-weight: 700; margin-bottom: 8px;">Продукты:</label>
                    <select name="product_id" required
                            style="font-size: 20px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; min-height: 50px;">
                        <option value="">-- Выберите продукт --</option>
                    </select>
                </div>
            
                <!-- Метка и поле для грамм -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <label style="font-weight: 700; margin-bottom: 8px;">Граммы:</label>
                    <input type="number" name="quantity" min="0" required
                        style="font-size: 20px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; min-height: 50px;">
                </div>
            
                <!-- Кнопка удаления -->
                <button type="button" onclick="removeProduct(this)"
                        style="height: 30px; width: 30px; font-size: 30px; color: white; background-color: red; border: none; 
                        display: flex; justify-content: center; align-items: center; margin-top: 30px; cursor: pointer;">×</button>
            </div>
        `;
        container.appendChild(productBlock);

        const newSelect = productBlock.querySelector('select[name="product_id"]');
        populateProductSelect(newSelect);
    }

    function removeProduct(button) {
        button.parentElement.remove();
    }

    document.getElementById('recipe-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.target;
        const title = form.title.value.trim();
        const body = form.body.value.trim();

        if (!title || !body) {
            alert('Пожалуйста, заполните название и описание рецепта');
            return;
        }

        const productBlocks = document.querySelectorAll('.product-block');
        const products_info = [];

        for (const block of productBlocks) {
            const product_id = parseInt(block.querySelector('select[name="product_id"]').value);
            const quantity = parseInt(block.querySelector('input[name="quantity"]').value);

            if (isNaN(product_id) || isNaN(quantity)) {
                alert('Пожалуйста, выберите продукт и укажите граммы');
                return;
            }

            products_info.push({ product_id, quantity, calories_per_unit: 0 });
        }

        const payload = {
            title,
            body,
            products_info
        };

        const token = localStorage.getItem('access_token');

        if (!token) {
            alert('Пожалуйста, войдите в систему');
            return;
        }

        try {
            const response = await fetch('http://127.0.0.1:8000/api/v1/recipes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify(payload)
            });

            if (response.status === 401) {
                alert('Пожалуйста, войдите в систему');
                return;
            }

            const result = await response.json();

            const responseBlock = document.getElementById('response');
            responseBlock.innerText = JSON.stringify(result, null, 2);
            responseBlock.hidden = false;

        } catch (error) {
            const responseBlock = document.getElementById('response');
            responseBlock.innerText = 'Ошибка при отправке: ' + error;
            responseBlock.hidden = false;
        }
    });
</script>
{% endblock %}